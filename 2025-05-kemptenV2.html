<!DOCTYPE HTML>
<html lang="de">
	<head>
		<title>Bike Werners - KemptenV2</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="icon" type="image/x-icon" href="images/BW.ico" />
	</head>
	<body class="homepage is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<!-- Bike Werner Logo -->
				<br>
				<br>
				<div align="center">
					<img src="images/BikeWernerLogo.png" alt="" width="33%" height="auto"><br>	
				</div>
			
				<header id="header">
					<div class="logo container">
						<div>
							<h1><a href="#" id="logo">Kempten: 09.05. - 11.05.2025</a></h1>
						</div>
					</div>
				</header>

			
				<nav id="nav">
					<ul>
						<li class="current"><a href="index.html">Home</a></li>
						<li>
							<a href="#">Geplante Touren</a>
							<ul>
								<li><a href="#">04. - 06.07.2025: tbd</a></li>
								<li><a href="#">05. - 07.09.2025: tbd</a></li>							
							</ul>
						</li>
						<li>
							<a href="absolviertetouren.html">Absolvierte Touren</a>
							<ul>
								<li><a href="2025-0-kempten.html">Kempten 2025</a></li>
								<li><a href="2024-8-ruhpolding.html">Ruhpolding 2024</a></li>
								<li><a href="2024-5-ettal.html">Ettal 2024</a></li>
								<li><a href="2023-9-badwiessee.html">Bad Wiessee 2023</a></li>
								<li><a href="2023-7-bodenmais.html">Bodenmais 2023</a></li>
							</ul>
						</li>
						<li>
							<a href="#">Sonstiges</a>
							<ul>
								<li><a href="wernerstats.html">Wernerstats</a></li>
							</ul>
						</li>
					</ul>
				</nav>

			
			
			<!-- Main -->
				<section id="main">
					<div class="container">
						<div class="row gtr-200">
							<div class="col-12">

								<!-- Features ✔✔️❓❌ -->
									<section class="box features">
										<h2 class="major"><span>Teilnehmer</span></h2>
										<ul class="special-images">
										    <li>
										        <img src="images/walzer.jpg" alt="Walzer Werner">
										        <span>Walzer ✔️</span>
										    </li>
										    <li>
										        <img src="images/wc.jpg" alt="WC Werner">
										        <span>WC  ✔️</span>
										    </li>
										    <li>
										        <img src="images/windel.jpg" alt="Windel Werner">
										        <span>Windel ✔️</span>
										    </li>
										    <li>
										        <img src="images/wu.jpg" alt="Wu Werner">
										        <span>Wu ✔️</span>
										    </li>
										    <li>
										        <img src="images/wurst.jpg" alt="Wurst Werner">
										        <span>Wurst ✔️</span>
										    </li>
										</ul>
									</section>

							</div>
							
							<div class="col-12">

								<!-- Features -->
									<section class="box features">
										<h2 class="major"><span>Unterkunft</span></h2>
										<div align=center>
											<div class="wernerstats">
												<!-- Button für Kalendereintrag deaktiviert
												<button onclick="openICS()">Kalendereintrag</button>
													<script>
													function openICS() {
													    window.location.href = "https://bikewerner.github.io/new/iCal/Kempten.ics";
													}
													</script>
												-->
												<p>booking.com: <a href="https://www.booking.com/Share-YWSdi7" target="_blank">Der Fürstenhof</a></p>
												<p>-reserviert-</p>
												<!-- <p>bei 4 Personen: 516€ (129,00€ p.P.)</p> -->
												<p>5 Personen: 576€ (115,20€ p.P.)</p>
												<iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2683.8404292492924!2d10.315980477447711!3d47.72634607969943!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x479c790e36665ef9%3A0xde25f1af34b37093!2sF%C3%BCrstenhof!5e0!3m2!1sde!2sde!4v1741175625570!5m2!1sde!2sde" width="100%" height="400" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
												<!-- <p>Option 2 506€: <a href="https://www.booking.com/Share-AWH40ky" target="_blank">Landhotel Hirsch</a></p> -->
											</div>
										</div>
									</section>

							</div>
							<div class="col-12">

								<!-- Features -->
									<section class="box features">
										<h2 class="major"><span>Verpflegung</span></h2>
										<div align=center>
											<!-- <p>Freitag Abendessen: folgt...</p> -->
											<p>Freitag Abendessen: <a href="https://maps.app.goo.gl/JrVon8MpPmvSPqak7" target="_blank">Pizzeria Amore Mio</a> - reserviert für 20:00 Uhr - <a href="https://www.amoremio.pizza/AmoreMioMenue25.pdf?_gl=1*qscqsw*_ga*MTg1NjQ2NzE3OS4xNzI4NDc5MDAy*_ga_ZSD2SFDWLL*MTczODk0OTgzOS4yOC4wLjE3Mzg5NDk4MzkuMC4wLjA." target="_blank">Speisekarte</a></p>
											<p>Samstag Mittagessen: <a href="https://maps.app.goo.gl/xAR9jRZvLQHYWGj67" target="_blank">Beim Öfner</a> nach 54/105 km</p>
											<!-- <p>Samstag Mittagessen: <a href="https://maps.app.goo.gl/hqjXhdu6wp8nx5nv9" target="_blank">Tauscher's Alm</a> nach 57,2/105km</p> -->
										  	<p>Samstag Abendessen: folgt...</p>
										  	<!-- <p>Samstag Abendessen: <a href="https://maps.app.goo.gl/7ng5jgCmVJ6JnN4x5" target="_blank">Restaurant Bell Ponte</a></p> -->
										</div>
									</section>

							</div>
							<div class="col-12">

								<!-- Features -->
									<section class="box features">
										<h2 class="major"><span>Touren</span></h2>
										<div align=center>
									        	<h3>Freitag: Aufwärmrunde</h3>
											<iframe src="https://www.komoot.com/de-de/tour/2086223501/embed?share_token=aGlXqHpeEcNqo4d4Q2geGH16PEthT98453UdETGjFwN8WxX5UH&profile=1" width="100%" height="650" frameborder="0" scrolling="no"></iframe>
											<br>
											<br>
											<br>
									        	<h3>Samstag: Haupttour</h3>
											<p><a href="https://connect.garmin.com/modern/course/340456554" target="_blank">Garmin Connect Import & Download .gpx/.fit</a> (inkl. Berg- & Sprintwertung, Mittagessen)</p>
											<div class="wernerstats">
												<p><img src="images/trikotberg.png" alt="Icon" class="title-icon"> Bergwertung Alte Jochstraße <b>bei 42,1 km</b> (Start Anstieg bei 40,1 km: 2,05 km; 260 Hm, Ø Steigung: 12,7 %)</p>
												<p>🍽️ Mittagessen <b>bei 54 km</b></p>
												<p><img src="images/trikotsprint.png" alt="Icon" class="title-icon"> Sprintwertung <b>bei 78,6 km</b></p>
											</div>
											<iframe src="https://www.komoot.com/de-de/tour/2083088614/embed?share_token=aUjiVsL6iBNyFZdwLAl02d6NmKPUJvuWwBwU7NBUsTvxsMiXy6&profile=1" width="100%" height="650" frameborder="0" scrolling="no"></iframe>
											<h3>Recap: Haupttour</h3>
											<video width="640" height="360" controls>
											  <source src="videos/kempten.mp4" type="video/mp4">
											</video>
										</div>
									</section>
<section class="box features">
  <h2 class="major"><span>Touren & Wetter</span></h2>

  <!-- Eingabefelder -->
  <div style="margin-bottom:1em; font-family:sans-serif;">
    <label for="starttime">🚴 Tourstart (Datum & Uhrzeit):</label>
    <input type="datetime-local" id="starttime" value="2025-05-05T08:00">

    <label for="avgSpeed" style="margin-left:1em;">Ø-Geschwindigkeit (km/h):</label>
    <input type="number" id="avgSpeed" value="20" min="5" max="50" step="1" style="width:60px;">

    <br><br>

    <label for="pauseAtKm">🛑 Pause bei (km):</label>
    <input type="number" id="pauseAtKm" value="42.1" min="1" step="0.1" style="width:60px;">

    <label for="pauseDuration" style="margin-left:1em;">⏱️ Pausendauer (hh:mm):</label>
    <input type="time" id="pauseDuration" value="01:15">

    <br><br>

    <button id="loadWeatherBtn">Wetter abrufen</button>
  </div>

  <!-- Info-Anzeige -->
  <div id="infoBox" style="margin-top:1em; font-family:sans-serif;"></div>

  <!-- Wetter-Zeitleiste -->
  <canvas id="weatherChart" style="width:100%; height:250px;"></canvas>

  <!-- Karte -->
  <div id="map" style="width:100%; height:500px;"></div>

  <!-- Leaflet + GPX + Chart.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.0/gpx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const apiKey = '6051678f687734a26fbc6c962e0b4820';
const gpxPath = 'gpx/WernersKemptenTannheimerTal.gpx';

const map = L.map('map').setView([47.7, 10.3], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// GPX laden und Karte zentrieren
const gpxLayer = new L.GPX(gpxPath, {
  async: true,
  marker_options: {
    startIconUrl: null,
    endIconUrl: null,
    shadowUrl: null
  }
}).on('loaded', function(e) {
  map.fitBounds(e.target.getBounds());
}).addTo(map);

// Wetterdaten abrufen bei Button-Klick
document.getElementById('loadWeatherBtn').addEventListener('click', async () => {
  const startTimeInput = document.getElementById('starttime').value;
  const avgSpeed = parseFloat(document.getElementById('avgSpeed').value);
  const pauseKm = parseFloat(document.getElementById('pauseAtKm').value);
  const pauseDurationStr = document.getElementById('pauseDuration').value;

  if (!startTimeInput || isNaN(avgSpeed) || isNaN(pauseKm)) {
    alert("Bitte alle Felder korrekt ausfüllen.");
    return;
  }

  const pauseParts = pauseDurationStr.split(':');
  const pauseMinutes = parseInt(pauseParts[0]) * 60 + parseInt(pauseParts[1]);

  const response = await fetch(gpxPath);
  const gpxText = await response.text();
  const parser = new DOMParser();
  const gpx = parser.parseFromString(gpxText, "application/xml");
  const trackPoints = Array.from(gpx.getElementsByTagName("trkpt"));

  const coords = trackPoints.map(pt => ({
    lat: parseFloat(pt.getAttribute("lat")),
    lon: parseFloat(pt.getAttribute("lon")),
    ele: parseFloat(pt.getElementsByTagName("ele")[0]?.textContent || 0)
  }));

  // Zeitberechnung mit Pause
  let startTime = new Date(startTimeInput);
  let totalDist = 0;
  const route = [];
  const R = 6371e3;

  for (let i = 1; i < coords.length; i++) {
    const dx = (coords[i].lon - coords[i-1].lon) * Math.PI / 180;
    const dy = (coords[i].lat - coords[i-1].lat) * Math.PI / 180;
    const a = Math.sin(dy/2)**2 + Math.cos(coords[i-1].lat * Math.PI / 180) * Math.cos(coords[i].lat * Math.PI / 180) * Math.sin(dx/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const d = R * c / 1000;

    totalDist += d;
    const travelTimeHr = totalDist / avgSpeed;
    let time = new Date(startTime.getTime() + travelTimeHr * 3600 * 1000);

    if (totalDist >= pauseKm && !route.some(p => p.pauseInserted)) {
      time = new Date(time.getTime() + pauseMinutes * 60000);
      route.push({ ...coords[i], dist: totalDist.toFixed(1), time, pauseInserted: true });
    } else {
      route.push({ ...coords[i], dist: totalDist.toFixed(1), time });
    }
  }

  // Wetterdaten von OpenWeather holen
  const weatherData = [];
  for (const pt of route) {
    const ts = Math.floor(pt.time.getTime() / 1000);
    const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${pt.lat}&lon=${pt.lon}&appid=${apiKey}&units=metric&lang=de`;

    try {
      const res = await fetch(url);
      const json = await res.json();

      const closest = json.list.reduce((prev, curr) => {
        return Math.abs(new Date(curr.dt * 1000) - pt.time) < Math.abs(new Date(prev.dt * 1000) - pt.time) ? curr : prev;
      });

      weatherData.push({
        time: pt.time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
        temp: closest.main.temp,
        rainProb: (closest.pop * 100).toFixed(0),
        rain: closest.rain?.['3h'] || 0,
        dist: pt.dist
      });

    } catch (e) {
      console.error("Wetterdatenfehler:", e);
    }
  }

  // Info anzeigen
  const temps = weatherData.map(w => w.temp);
  const rains = weatherData.map(w => w.rain);
  const probs = weatherData.map(w => w.rainProb);

  const infoBox = document.getElementById("infoBox");
  infoBox.innerHTML = `
    <p><b>Start:</b> ${startTime.toLocaleString('de-DE')}</p>
    <p><b>Ankunft:</b> ${route[route.length - 1].time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}</p>
    <p><b>Min/Max/Ø Temperatur:</b> ${Math.min(...temps).toFixed(1)} / ${Math.max(...temps).toFixed(1)} / ${(temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1)} °C</p>
    <p><b>Max Regenwahrscheinlichkeit:</b> ${Math.max(...probs)}%</p>
    <p><b>Gesamtniederschlag:</b> ${rains.reduce((a, b) => a + b, 0).toFixed(1)} mm</p>
  `;

  // Diagramm erstellen
  const ctx = document.getElementById('weatherChart').getContext('2d');
  if (window.weatherChartInstance) {
    window.weatherChartInstance.destroy();
  }

  window.weatherChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: weatherData.map(w => `${w.time} (${w.dist} km)`),
      datasets: [
        {
          label: 'Temperatur (°C)',
          data: weatherData.map(w => w.temp),
          borderColor: 'red',
          yAxisID: 'y',
          tension: 0.2
        },
        {
          label: 'Regenwahrscheinlichkeit (%)',
          data: weatherData.map(w => w.rainProb),
          borderColor: 'blue',
          yAxisID: 'y1',
          borderDash: [4, 4],
          tension: 0.2
        },
        {
          label: 'Niederschlag (mm)',
          data: weatherData.map(w => w.rain),
          borderColor: 'gray',
          yAxisID: 'y2',
          borderDash: [2, 2],
          tension: 0.2
        }
      ]
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      stacked: false,
      plugins: {
        title: {
          display: true,
          text: 'Wetterverlauf entlang der Route'
        }
      },
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: {
            display: true,
            text: 'Temperatur (°C)'
          }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          title: {
            display: true,
            text: 'Regenwahrscheinlichkeit (%)'
          },
          grid: {
            drawOnChartArea: false
          }
        },
        y2: {
          type: 'linear',
          display: true,
          position: 'right',
          title: {
            display: true,
            text: 'Niederschlag (mm)'
          },
          grid: {
            drawOnChartArea: false
          },
          offset: true
        }
      }
    }
  });
});
</script>

</section>




								

							</div>
							
							<div class="col-12">
								<section class="box features">
									<h2 class="major"><span>Absolvierte Touren</span></h2>
									<div>
								        	<div id="row" class="row"></div>
								            		<script>
									                fetch("pages/absolviertetourenfooter.html")
									                    .then(response => response.text())
									                    .then(data => document.getElementById("row").innerHTML = data)
									                    .catch(error => console.error("Fehler beim Laden der Datei:", error));
								            		</script>
							        		</div>    
								</section>
							</div>

						</div>
					</div>
				</section>

			<!-- Footer -->
				<footer id="footer">
					<div class="container">
						<!-- Copyright -->
							<div id="copyright">
								<ul class="menu">
									<li>&copy; Bike Werners. All rights reserved</li>
								</ul>
							</div>

					</div>
				</footer>

		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
	</body>
</html>
